{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>{{ book.name }}</h2>
  <p class="muted">Source: {{ book.source_url or "" }}</p>
  <form method="post" action="/books/{{ book.id }}/build">
    <button type="submit">Build Today's Issue</button>
  </form>
  <form method="post" action="/books/{{ book.id }}/articles/clear" onsubmit="return confirm('Clear captured articles and issues for this book?');">
    <button type="submit">Clear Captured Articles</button>
  </form>
  {% if issue %}
    <p>Latest issue: {{ issue.title }} - <a href="/download/{{ issue.id }}.epub">Download EPUB</a></p>
    {% if send_message %}
      <p class="success">{{ send_message }}</p>
    {% endif %}
    {% if send_error %}
      <p class="error">{{ send_error }}</p>
    {% endif %}
    {% if kindle_send.available %}
      <form method="post" action="/issues/{{ issue.id }}/send">
        <button type="submit">Send to Kindle</button>
      </form>
    {% else %}
      {% if kindle_send.reason == "missing_config" %}
        <p class="muted">
          Kindle-send not configured. Run:
          <code>docker compose exec api kindle-send --config {{ kindle_send.config_path }} send https://example.com</code>
        </p>
      {% elif kindle_send.reason == "missing_binary" %}
        <p class="muted">Kindle-send binary not available in the container.</p>
      {% endif %}
    {% endif %}
    <div class="status">
      <p>
        Build status:
        <span class="badge {{ issue.build_status or 'unknown' }}">{{ issue.build_status or "unknown" }}</span>
        {% if issue.build_started_at %}<span class="muted">Started {{ issue.build_started_at }}</span>{% endif %}
        {% if issue.build_finished_at %}<span class="muted">Finished {{ issue.build_finished_at }}</span>{% endif %}
      </p>
      {% if issue.build_status == "building" %}
        <p class="muted">Build in progress. This page will refresh automatically.</p>
        <script>
          setTimeout(() => location.reload(), 5000);
        </script>
      {% endif %}
      {% if issue.build_status == "failed" and issue.build_error %}
        <p class="error">Build failed: {{ issue.build_error }}</p>
      {% endif %}
      {% if issue.audit_summary %}
        <p>
          Audit: {{ issue.audit_summary.total_articles }} articles,
          {{ issue.audit_summary.flagged_articles }} flagged,
          {{ issue.audit_summary.healed_articles }} healed,
          {{ issue.audit_summary.fallback_used }} fallback.
        </p>
        <p><a href="/issues/{{ issue.id }}/audit">Download audit JSON</a></p>
      {% endif %}
    </div>
  {% endif %}
</section>

<section class="panel">
  <h3>Latest Snapshot Items</h3>
  {% if items %}
    <ul class="list">
      {% for item in items %}
        <li>
          <a href="{{ item.url }}" target="_blank">{{ item.title }}</a>
          <span class="muted">{{ item.ts or "" }}</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No snapshot items yet.</p>
  {% endif %}
</section>

<section class="panel">
  <h3>Captured Articles</h3>
  {% if articles %}
    <ul class="list">
      {% for article in articles %}
        <li>
          <strong>{{ article.title }}</strong>
          <span class="muted">{{ article.url }}</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="muted">No articles captured yet.</p>
  {% endif %}
</section>
{% endblock %}
